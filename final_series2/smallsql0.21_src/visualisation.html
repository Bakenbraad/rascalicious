<!DOCTYPE html>
<meta charset="utf-8"/>
<head>
<link rel="stylesheet" href="style.css">
</head>
<body>
<button onclick="buttonChangeCat()" id="categoryButton">Change Category</button>
<button onclick="buttonChangeFile()" id="categoryButton">Change Project</button>
<div id="clonevis" style="z-index: -1">	
</div>
<div id="cloneList">
</div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="events.js"></script> 
<script>

	var diameter 		= 900,
		radius 			= diameter / 2,
		innerRadius 	= radius - 120,
		m0,
		pi 				= Math.PI,
		selectedNode 	= {},
		filenameToNodes = {},
		nodeToLocations	= {},
		nodeToInfo		= {},
		filenameToStats	= {},
		windowloc 		= window.location.href.split("/").slice(0, -1).join('/'),
		urlParams		= window.location.href.split("?"),
		projectAndCat	= urlParams[1].split("&"),
		project			= projectAndCat[0].split("=")[1]
		cloneCat		= projectAndCat[1].split("=")[1];
	
	
	
	d3.json("fileNameToNodes_"+project+cloneCat+".json", function(error, classes) {
		if (error) throw error;
		
		filenameToNodes = getJSONObjs(classes,"fileNameToNodes", "filename", "nodes" );
		filenameToStats = getJSONObjs(classes,"fileNameToNodes", "filename", "cloneinfo" );
	});
	
	d3.json("nodeToLocs_"+project+cloneCat+".json", function(error, classes) {
		if (error) throw error;
		
		nodeToLocations = getJSONObjs(classes,"nodeToLocsJSON", "node", "locs" );
		nodeToInfo 		= getJSONObjs(classes,"nodeToLocsJSON", "node", "nodesize" );	
	});
	
	
		
	
	var cluster = d3.cluster()
		.size([360, innerRadius]);
		
	var line = d3.radialLine()
		.curve(d3.curveBundle.beta(0.85))
		.radius(function(d) { return d.y; })
		.angle(function(d) { return d.x / 180 * Math.PI; });
		
	var svg = d3.select("#clonevis").append("svg")
		.attr("width", diameter)
		.attr("height", diameter)
		.append("g")
		.attr("transform", "translate(" + radius + "," + radius + ")")
		
	var link = svg.append("g").selectAll(".link"),
		node = svg.append("g").selectAll(".node");
		
	d3.json("fileRelations_"+project+cloneCat+".json", function(error, classes) {
		if (error) throw error;
		
		var root = packageHierarchy(classes)
			.sum(function(d) { return d.size; });
			
		cluster(root);
		
		link = link		
			.data(packageLocations(root.leaves()))
			.enter().append("path")
			.each(function(d) {
				d.source = d[0];
				d.target = d[d.length-1];
			})
			.attr("style","stroke : blue; stroke-opacity: 0.5; stroke-width: 0.5px;")
			.attr("class", "link")
			.attr("id", function(d) { return "source-" + d.source.data.filename + " target-" + d.target.data.filename;})
			.attr("d", line);

		node = node
			.data(root.leaves())
			.enter().append("text")
			.each(function(d) { d.selected = false;})
			.attr("text-decoration", function(d) { if(d.data.locs.indexOf(d.data.filename) !== -1) { return "underline" }})
			.attr("class", "node")
			.attr("dy", "0.31em")
			.attr("cursor","pointer")
			.attr("id", function(d) { return "node-" + d.data.filename; })
			.attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + 8) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
			.attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
			.text(function(d) { return d.data.key; })
			.on("mouseover", mouseover)
			.on("mouseout", mouseout)
			.on("click", mouseclick);
	});

	function makeCloneCollapsible(array) {
	
		var div 		= document.createElement('div'),
			arraysize 	= array.length,
			collapsible,
			content;
			
			
		for (var i = 0; i < arraysize; i++) {
		
			// Create a button with clone number.
			collapsible = document.createElement('button')
			collapsible.className = "collapsible";
			linkCount = getAddressCount(array[i])
			
			collapsible.innerHTML = "Clone number " + String((i + 1)) + " occurs in " + String(linkCount) + " file(s)";
			 
			// Content below button is the corresponding occurrance locations.
			content = document.createElement('div');
			content.className = "content";
			content.appendChild(makeOccurranceList(array[i]));	
			
			// Append the new elements in order to the div.
			div.appendChild(collapsible);
			div.appendChild(content);
		}
		
		return div;
	}
	
	function getAddressCount(array){
		var output = 0;
		var seen = [];
		
		for (j = 0; j < array.length; j++) {
			splitElem = array[j].split("|");		
			if(seen.indexOf(splitElem[0]) === -1) {
				seen += splitElem[0];
				output += 1
			}
		}
		return output;
	}
	
	function makeOccurranceList(array) {
    // Create the list element:
		var list = document.createElement('div');
			arraysize = array.length;
		console.log(array);
		for (var i = 0; i < arraysize; i++) {
			// Set its contents:
			var urllink = document.createElement('a');
			urllink.className = "urllink";
			
			fileLocationWithOffsets = array[i].split("/").pop();
			fileloc = array[i].split("|")[0];
			urllink.href =  windowloc + "/" + fileloc;
			
			
			// get the offsets
			offsetstart = fileLocationWithOffsets.split("|")[1];
			offsetend = fileLocationWithOffsets.split("|")[2];
			
			urllink.innerHTML = fileloc.split("/").pop();
			list.appendChild(urllink);
			list.appendChild(document.createElement('br'));
			list.appendChild(document.createTextNode("starts at row, col: " + offsetstart + " ends at row, col: " + offsetend));
			list.appendChild(document.createElement('br'));
		}
		// Finally, return the constructed list:
		return list;
	}
	
	function setCollapsibleListeners() {
		var coll = document.getElementsByClassName("collapsible");
		var i;

		for (i = 0; i < coll.length; i++) {
			coll[i].addEventListener("click", function() {
				this.classList.toggle("active");
				var content = this.nextElementSibling;
				console.log(content);
				if (content.style.display === "block") {
					content.style.display = "none";
				} else {
					content.style.display = "block";
				}
			});
		}
	}
	
	function getFileCloneClasses(d) { 
		var clonedNodes = filenameToNodes[d.data.filename],
			clones = {},
			i;
		
		for ( i = 0; i < clonedNodes.length; i++) {
			nodeString = clonedNodes[i];
			cloneLocs = nodeToLocations[nodeString];
			clones[i] = cloneLocs;
		}
		clones.length = i;
		return clones;
	}

	function getJSONObjs(classes, arrayNames, attr1, attr2) {
		var map 			= {},
			filenameLength 	= classes[arrayNames].length;
			
		for( i = 0; i < filenameLength; i++){
			var obj = classes[arrayNames][i];
				map[obj[attr1]] = obj[attr2];
			}
		return map;
	}	
	
	// Lazily construct the package hierarchy from class names.
	function packageHierarchy(classes) {
		var map = {};
		function find(filename, data) {
			var node = map[filename], i;
			if (!node) {
				node = map[filename] = data || {filename: filename, children: []};
				if (filename.length) {
					node.parent = find(filename.substring(0, i = filename.lastIndexOf(".")));
					node.parent.children.push(node);
					node.key = filename.substring(i + 1);
				}
			}
			return node;
		}
	
		classes.forEach(function(d) {
			find(d.filename, d);
		});
		
		return d3.hierarchy(map[""]);
	}
	
	// Return a list of imports for the given array of nodes.
	function packageLocations(nodes) {
	
		var map = {},
		locs = [];
		
		// Compute a map from name to node.
		nodes.forEach(function(d) {
			map[d.data.filename] = d;
		});
		
		// For each import, construct a link from the source to target node.
		nodes.forEach(function(d) {
			if (d.data.locs) d.data.locs.forEach(function(i) {
				locs.push(map[d.data.filename].path(map[i]));
			});
		});
	
		return locs;
	}	
	
	function updatePath(source, target, color, opacity, width, textcolor) {
		document.getElementById("source-" + source + " target-" + target).style.stroke = color;
		document.getElementById("source-" + source + " target-" + target).style["stroke-opacity"] = opacity; 
		document.getElementById("source-" + source + " target-" + target).style["stroke-width"] = width + "px";
		document.getElementById("node-" + target).style.fill = textcolor;
	}

	
	
</script>
</body>